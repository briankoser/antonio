<!DOCTYPE html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Antonio, a Board Game Geek trading tool</title>
        <meta name="description" content="Antonio, a Board Game Geek trading tool">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" sizes="192x192" href="/img/favicons/192.png">
        
        <link rel="stylesheet" href="../css/normalize.css">
        <link rel="stylesheet" href="../css/normalize-opentype.css">
        <link rel="stylesheet" href="../css/boilerplate.css">
        <link rel="stylesheet" href="../css/main.css">
        
        <!--[if lt IE 9]>
            <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
            <script>window.html5 || document.write('<script src="js/vendor/html5shiv.js"><\/script>')</script>
        <![endif]-->
        
        <link href='http://fonts.googleapis.com/css?family=Source+Serif+Pro:400,700' rel='stylesheet'>
        <style>
            * + * {
              margin-top: 1em;
            }
            
            button {
                vertical-align: middle;
            }
            
            button[disabled] {
                opacity: .5;
            }
            
            h1, h2, h3 {
                margin-bottom: 0;
            }
            
            input {
            }
            
            label {
                vertical-align: middle;
            }
            
            p {
                max-width: 30em;
            }
            
            .no-list-style li {
                list-style-type: none;
            }
            
            .tight-margin-top {
                margin-top: .5em;
            }
            
            .user-list {
                font-size: .8em;
                margin-left: 1em;
            }
        </style>
    </head>
    <body>
        <div class="header-container">
            <header role="banner" class="wrapper clearfix">
                <h1 class="title">Antonio, a Board Game Geek trading tool</h1>
                <nav role="navigation">
                </nav>
            </header>
        </div>

        <div class="main-container">
            <main class="main wrapper clearfix">
                <p>Antonio finds the <abbr class="small-caps" title="Board Game Geek">BGG</abbr> users that want to trade for your game, and lists the games that those users have on the trading block.</p>
                
                <h2>Your game</h2>
                <div>
                    <label for="gameId">BGG Game ID</label>
                    <input id="gameId" type="text"></input>
                    <button id="getUsersWanting">Find some trades!</button>
                </div>
                
                <article id="artGamesAvailable">
                    <h2>Their games</h2>
                    <ol id="olGamesAvailable" class="no-list-style">
                    </ol>
                </article>
                
                <article id="artUsersUnavailable">
                    <h3>I don’t know what these users have…yet!</h3>
                    <span class="subheader">BGG is still generating these users’ game collections; <strong>wait a few minutes and try again</strong>. On a busy day, this could take hours. Time for a quick game of <abbr class="small-caps" title="Twilight Imperium (Third Edition), a long board game">TI3</abbr>! :)</span>
                    <ul id="users-unavailable" class="tight-margin-top"></ul>
                </article>
            </main> <!-- #main -->
        </div> <!-- #main-container -->

        <div class="footer-container">
            <footer role="contentinfo" class="wrapper">
                <span><a href="https://github.com/briankoser/antonio">Built by Brian Koser</a></span>
            </footer>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-2.1.3.js"><\/script>')</script>

        <script src="/js/main.js"></script>
        <script src="/js/antonio.js"></script>
        
        <script>
            $(document).ready(function() {
                $('#artUsersUnavailable').hide();
                $('#artGamesAvailable').hide();
            });
            
            // Events
            $('#getUsersWanting').click(function() {
                $('#artGamesAvailable').show();
                
                var btnGetUsersWanting = $('#getUsersWanting');
                var btnGetUsersWantingText = btnGetUsersWanting.html();
                btnGetUsersWanting.prop('disabled', true).html('Processing…');
                
                var gameID = $('#gameId').val(); //'71906';
                btnGetUsersWanting.html('Searching BGG for users that want your game…');
                $.getJSON('http://bgg-users-want.azurewebsites.net/api/game/' + gameID, function(data) {
                    /*var*/ gamesAvailable = {};
                    /*var*/ usersDataUnavailable = [];
                    
                    // loop through users wanting the game
                    $.each(data.UsersWant, function(index, item) {
                        var userName = item.Name;
                        btnGetUsersWanting.html('Checking what games ' + userName + ' is trading…');
                        
                        if (userName === 'klurejr' || userName === 'Base the Bass' || userName === 'tavlas') {
                            var url = 'https://bgg-api.herokuapp.com/api/v1/collection?username=' + userName + '&trade=1';
                            
                            $.getJSON(url, function(data) {
                                if (data.hasOwnProperty('message')) {
                                    usersDataUnavailable.push(userName);
                                    
                                    $('#users-unavailable').append(
                                        $('<li>').append(userName)
                                    );
                                    
                                    $('#artUsersUnavailable').show();
                                }
                                else {
                                    // loop through games user has for trade
                                    $.each(data.items.item, function(index, item) {
                                        var game = item.name[0]['_'];
                                        
                                        if(!gamesAvailable.hasOwnProperty(game)) {
                                            gamesAvailable[game] = [];
                                        }
                                        
                                        gamesAvailable[game].push(userName);
                                    });
                                }
                            });
                        }
                        
                        var userUrl = 'http://boardgamegeek.com/user/';
                        var gameUrl = 'http://boardgamegeek.com/boardgame/';
                        $.each(gamesAvailable, function(game, userList) {
                            var userAnchorsString = 
                                $.map(userList, 
                                    function(item, index) {
                                        return $('<a>', {href:userUrl + item})
                                        .append(item)
                                        .prop('outerHTML')
                                    }
                                )
                                .sort()
                                .join(', ');
                            
                            var spanUserList = $('<span>', {'class':'user-list'}).append(userAnchorsString);
                            var liGame = $('<li>').append(game).append(spanUserList);
                            $('#olGamesAvailable').append(liGame);
                        });
                        
                        btnGetUsersWanting.prop('disabled', false).html(btnGetUsersWantingText);
                    });
                });
            });
            
            // Methods
        </script>
    </body>
</html>